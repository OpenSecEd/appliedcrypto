\title{Ciphers and shared-key encryption}
\author{Daniel Bosk\thanks{%
    With some ideas from Douglas Wikström.
}}
\institute{KTH EECS}

\mode*

\begin{frame}
  \maketitle
\end{frame}

\begin{abstract}
  \input{abstract.tex}
\end{abstract}

\clearpage

\begin{frame}
  \only<presentation>{\tableofcontents[hideallsubsections]}
  \only<article>{\tableofcontents}
\end{frame}

\clearpage

\section{Introduction}

\begin{frame}
  \begin{exercise}
    When you hear \enquote{cryptography}, what do you think it does?
    Take 30 seconds and write down a one-sentence answer.
  \end{exercise}

  \ltnote{%
    Try-first: activate prior knowledge before terminology.
    The contrast between student intuition and the definitions below makes the
    scope (contents vs existence) discernible.
  }
\end{frame}

\begin{frame}
  \begin{itemize}
    \item The word has its origin in greek~\footfullcite{OED2013cg}:
      \begin{description}
        \item[\ibygr{krupto's}] (\emph{kryptos}) meaning 
          hidden~\footfullcite{OED2013c}.
        \item[\ibygr{gra'fos}] (\emph{graphos}) meaning 
          writing~\footfullcite{OED2013g}.
      \end{description}

      \pause{}

    \item The area has been around for ages.

      \pause{}

    \item We should not confuse it with \emph{steganography}.
    \item Steganography concerns hiding a message's \emph{existence}.
    \item Cryptography concerns hiding a message's \emph{contents}.
  \end{itemize}
\end{frame}

\begin{frame}
  \blockcquote{GoldreichFoC-1}{%
    Cryptography is concerned with the conceptualization, definition,
    and construction of computing systems that address security
    concerns.%
  }

  \blockcquote{Douglas Wikström}{%
    Cryptography is not limited to the construction and analysis of
    well-known notions such as encryption or hash functions. Any
    concept which has security properties is a cryptographic notion.
  }
\end{frame}

\begin{frame}
  \begin{itemize}
    \item Then it was an art, now it's a science.

      \pause{}

    \item People used \enquote{clever} constructions.
    \item These were thought to be secure: \enquote{How can anyone figure this 
        out?}

      \pause{}

    \item Well, it turns out that there are always a lot of people with a lot 
      of time and motivation \dots
  \end{itemize}
\end{frame}

\subsection{Outline}

\begin{frame}
  \begin{description}
    \item[Shared-key]
      Stems from the classical crypto where a key is shared between two users.

      \pause

    \item[Public-key]
      This is more modern crypto, from 1970s.
      Each user has a public and a private key.

      \pause

    \item[Counter-intuitive]
      More modern, from 1980s and onwards.
      How to do computations on secret inputs, prove knowledge without revealing 
      of what.
  \end{description}
\end{frame}


\section{Shared-key cryptography}

\ltnote{%
  Variation theory (try-first): start from learners' everyday experience
  (invariant: "private communication"; varies later: "how we achieve it")
}
\begin{frame}
  \begin{question}
    Alice and Bob wish to communicate in private.
    You all know how to do this with friends! How?
  \end{question}

\end{frame}

\note{%
  Use a quick whole-class prompt: “What do you already do to keep a message
  private from others?” Collect 2--3 ideas (e.g., whispering, inside jokes,
  code words). Do not evaluate yet; we want prior knowledge on the table.
}

\ltnote{
  Variation theory (contrast): show "public transmission" vs "private 
  meaning"
  Invariant: message exchange; Varies: representation (m vs c)
}
\begin{frame}
  \begin{block}{Cipher (Symmetric Cryptosystem)}
    Is the following possible?
    \begin{enumerate}
      \item Alice transforms her message \(m\) into a garbled string \(c\).
      \item Alice sends the garbled string \(c\) to Bob.
      \item Bob transforms \(c\) back to \(m\).
    \end{enumerate}

    \medskip
    \emph{Goal:} \(c\) hides the content of \(m\).
  \end{block}

  \begin{onlyenv}<2>
  \ltnote{%
    Variation theory (try-first): leave space for student hypotheses
    Critical aspect to discern: Bob can invert only if he has extra 
    information
  }
  \begin{exercise}
    What is missing for this to work?
  \end{exercise}

  \end{onlyenv}
\end{frame}

\note{%
Ask students to point out what each symbol means: \(m\) (message/meaning),
\(c\) (ciphertext/garbled text). Emphasize that the channel is assumed to be
observable (others can see \(c\)). Then ask: “What could go wrong if anyone
can do step 3?” Lead into the missing ingredient.

Give 30--60 seconds of think-pair-share. Listen for phrases like:
“a password,” “a key,” “something only they know.” If someone says
“a more complicated algorithm,” steer them toward: complexity is not
enough if it is public—what matters is \emph{secret information}.
}

\begin{frame}
  \begin{definition}[Joint secret]
    A \emph{joint secret} is a piece of shared information of Alice and Bob
    that is hard to guess for others.
  \end{definition}

  % Variation theory (generalization): name the invariant pattern behind many
  % everyday strategies (inside jokes, passwords, secret handshakes)
\end{frame}

\note{%
Connect back to the first question: many “friend privacy” methods rely on
shared background knowledge. State explicitly: in cryptography this shared
secret is typically called a \emph{key}. (You can mention the word “key”
now, or save it for the next slide if you prefer pacing.)
}

\begin{frame}
  \begin{example}[Joint secret: shared memory]
    \enquote{Remember how many fish we caught that rainy day?}
  \end{example}

  % Variation theory (contrast): "meaningful to Alice/Bob" vs "hard to guess for others"
  % Invariant: shared secret; Varies: the form (memory-based vs random bits)
\end{frame}

\note{%
Ask: “Why might this be hard for an outsider?” Highlight: it depends on
shared experience. Then point out a limitation: it may not be uniformly
hard to guess; it could leak via social media, friends, etc. This motivates
a more formal secret.
}

\begin{frame}
  \begin{example}[Joint secret: random bits]
    Alice and Bob agree on a sequence of randomly chosen bits intended
    for use later.
  \end{example}

  % Variation theory (generalization): move from informal secrets to formal keys
  % Critical aspect: secrecy should not rely on obscurity of the method, but on the key
\end{frame}

\note{%
Stress: the bits are \emph{random} and \emph{shared only by Alice and Bob}.
Then connect to the cipher story: the missing ingredient is a joint secret
(a shared key) that enables Bob to reverse the transformation, while others
cannot. Optionally preview: next we will formalize encryption/decryption
as algorithms that take \(m\) and a key \(k\) to produce \(c\).
}

\subsection{Kerckhoff's Principle}

\begin{frame}
  \begin{block}{A quote\footfullcite{KerckhoffsPrinciple}}
    \begin{displayquote}\relax
      [A cryptosystem] should not require secrecy, and it should not be 
      a problem
      if it falls into the enemy hands;
    \end{displayquote}
  \end{block}

  \pause{}

  \begin{block}{Kerckhoff's Principle}
    \begin{itemize}
      \item No security-by-obscurity
      \item The key should be the only secret
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{remark}
    \begin{itemize}
      \item This doesn't mean we must tell the adversary what we're using.
      \item But we shouldn't loose any security if we do.
    \end{itemize}
  \end{remark}
\end{frame}

\subsection{Ciphers}

\begin{frame}
  \begin{idea}
    \begin{itemize}
      \item Alice and Bob share a (small) common secret.

        \pause{}

      \item Alice takes a message, combines it with the secret, sends it to 
        Bob.

        \pause{}

      \item If Eve captures whatever Alice sent, she shouldn't learn anything 
        about the message.

        \pause{}

      \item Bob combines what he received with the secret and gets the message.
    \end{itemize}
  \end{idea}
\end{frame}

\begin{frame}
  \begin{block}{Block-cipher encryption}
    \begin{description}
      \item[Input] A fixed-sized \emph{key} \(k\), a fixed-sized block of 
        \emph{plaintext} \(p\).
      \item[Output] A fixed-sized block of \emph{ciphertext} \(c\).
      \item[Notation] \(\Enc[_k][p] = c\)
    \end{description}
  \end{block}

  \pause{}

  \begin{block}{Block-cipher decryption}
    \begin{description}
      \item[Input] A fixed-sized \emph{key} \(k\), a fixed-sized block of 
        \emph{ciphertext} \(c\).
      \item[Output] A fixed-sized block of \emph{plaintext} \(p\).
      \item[Notation] \(\Dec[_k][c] = p\)
    \end{description}
  \end{block}
\end{frame}

\begin{frame}
  \begin{definition}[Crypto 
    system]\footfullcite{Stinson2006cta}\label{CryptoSystem}
    \begin{itemize}
        \item A \emph{crypto system} is a tuple \((\M, \C, \K, \E, \D)\), 
          where:
          \begin{itemize}
            \item \(\M\) is a finite set of \emph{plaintexts} or messages,
            \item \(\C\) is a finite set of \emph{ciphertexts},
            \item \(\K\) is the \emph{keyspace}, a finite set of keys.
            \item \(\E\) and \(\D\) are the sets of encryption and decryption
              rules, respectively.
          \end{itemize}

          \pause{}

        \item For every \(k\in \K\) there is a
          \(\Enc_k\in \E\) and
          \(\Dec_k\in \D\) such that
          \begin{itemize}
            \item \(\Enc_k\colon \M\to \C\) and \(\Dec_k\colon \C\to \M\) are 
              functions and
            \item \(\Dec[_k][\Enc[_k][m]] = m\) for all plaintexts \(m\in \M\).
          \end{itemize}
      \end{itemize}
  \end{definition}
\end{frame}

\begin{frame}
  \begin{definition}[Shift Cipher]\label{ShiftCipher}
    \begin{itemize}
      \item Let \(\M = \C = \K = \ZZ_{29}\)
      \item For each \(k\in \K\) we define
        \begin{align}
          \nonumber
          \Enc[_k][m] &= (m + k) \bmod 29, m\in \M, \text{\ och } \\
          \nonumber
          \Dec[_k][c] &= (c - k) \bmod 29, c\in \C.
        \end{align}
    \end{itemize}
  \end{definition}

  \pause{}

  \begin{example}
    \begin{itemize}
      \item \(\Enc[_3][7] = 7+3 \bmod 29 = 10\)\hfill h\(\to\)J
      \item \(\Enc[_3][4] = 4+3 \bmod 29 = 7\)\hfill e\(\to\)G
      \item \(\Enc[_3][9] = 9+3 \bmod 29 = 12\)\hfill j\(\to\)L
    \end{itemize}
  \end{example}
\end{frame}

\begin{frame}
  \begin{remark}
    \begin{itemize}
      \item The shift cipher is a classical cipher --- also know as the Caesar 
        Cipher.
      \item It's easily broken \emph{by hand}!
      \item It's used here for illustrative purposes.
    \end{itemize}
  \end{remark}
\end{frame}

\subsection{Security}

\begin{frame}
  \begin{definition}[Perfect secrecy]\footfullcite{ShannonSecrecy}
    \begin{itemize}
      \item Cryptosystem \((\M, \C, \K, \E, \D)\).
      \item Stochastic variables \(M, C\).
      \item \emph{Perfect secrecy} if and only if \[\Pr(M = m\mid C = c) 
          = \Pr(M = m)\] for all \(m\in \M\) and \(c\in \C\).
    \end{itemize}
  \end{definition}

  \pause{}

  \begin{remark}
    Equivalent to \(H(M\mid C) = H(M)\), i.e.\ ciphertext does not reveal 
    anything about plaintext.
  \end{remark}
\end{frame}

\begin{frame}
  \begin{theorem}[Shannon's theorem]
    \begin{itemize}
      \item Assume cryptosystem \((\M, \C, \K, \E, \D)\) such that \(|\K| 
          = |\C| = |\M|\).

        \pause{}

      \item This provides perfect secrecy if and only if
        \begin{enumerate}
          \item every key \(k\in \K\) is used with equal probability 
            \(1/|\K|\),
          \item for every plaintext \(m\in \M\) and \(c\in \C\) there is a 
            unique key such that \(\Enc[_k][m] = c\).
        \end{enumerate}
    \end{itemize}
  \end{theorem}
\end{frame}

\begin{frame}
  \begin{example}[One-time Pad]
    \begin{itemize}
      \item Let \(n\) be a positive integer.
      \item Let \(\M = \C = \K = (\ZZ_2)^n\).

        \pause{}

      \item For each key \(k = (k_1, \ldots, k_n)\in \K\), plaintexts \(m 
          = (m_1, \ldots, m_n)\in \M\) and ciphertexts \(c = (c_1, \ldots, 
          c_n)\in \C\) we define
        \[\Enc[_k][m] = (m_1 + k_1, \ldots, m_n + k_n)\]

        \pause{}

      \item We also define \(\Dec = \Enc\).

        \pause{}

      \item \(k\in \K\) must be chosen uniformly randomly for each encryption.
    \end{itemize}
  \end{example}
\end{frame}

\begin{frame}
  \begin{definition}[\Acl{PRP}, \acs{PRP}]\footfullcite{KatzLindell-v1}
    \begin{itemize}
      \item Let \(F\colon \{0,1\}^s\times \{0, 1\}^n\to \{0,1\}^n\).

        \pause{}

      \item \(F\) is \iac{PRP} if
        \begin{enumerate}
          \item for any \(k\in \{0, 1\}^s\), \(F\) is a bijection;

            \pause{}

          \item for any \(k\in \{0, 1\}^s\), we can \enquote{efficiently} 
            evaluate \(F_k(x)\);

            \pause{}

          \item for all \enquote{efficient} distinguishers~\(D\),
            \[\left|\Pr[D^{F_k}(1^n) = 1] - \Pr[D^{f_n}(1^n) = 1]\right| 
              < \epsilon(s)\] if we choose \(k\in \{0,1\}^s\) and the random 
            permutation \(f_n\) uniformly at random.
        \end{enumerate}
    \end{itemize}
  \end{definition}
\end{frame}


\section{Ciphers (shared-key encryption)}

\subsection{The interface and the goal}

\begin{frame}
  \begin{idea}
    \begin{itemize}
      \item Alice and Bob share a (small) secret key \(k\).
      \item Alice computes ciphertext \(c = \Enc_k(m)\) and sends \(c\).
      \item Bob computes \(m = \Dec_k(c)\).
      \item An eavesdropper should learn (essentially) nothing about \(m\) from
        \(c\).
    \end{itemize}
  \end{idea}
\end{frame}

\begin{frame}
  \begin{block}{Symmetric encryption in one line}
    \begin{itemize}
      \item Same key for encryption and decryption.
      \item Main practical challenge: \emph{key distribution}.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{block}{Block-cipher encryption}
    \begin{description}
      \item[Input] key \(k\), plaintext block \(p\).
      \item[Output] ciphertext block \(c\).
      \item[Notation] \(\Enc[_k][p] = c\)
    \end{description}
  \end{block}

  \pause

  \begin{block}{Block-cipher decryption}
    \begin{description}
      \item[Input] key \(k\), ciphertext block \(c\).
      \item[Output] plaintext block \(p\).
      \item[Notation] \(\Dec[_k][c] = p\)
    \end{description}
  \end{block}
\end{frame}

\subsection{Why classical ciphers fail}

\begin{frame}
  \begin{definition}[Shift cipher (Caesar)]
    \begin{itemize}
      \item Think of letters as integers modulo \(n\) (e.g., \(n=26\) or
        include space).
      \item Key \(k\in\mathbb{Z}_n\).
      \item \(\Enc[_k][m] = (m+k)\bmod n\), \(\Dec[_k][c] = (c-k)\bmod n\).
    \end{itemize}
  \end{definition}
\end{frame}

\begin{frame}
  \begin{exercise}
    You intercept a Caesar-encrypted message, but you do not know the key.

    How would you try to break it?
  \end{exercise}

  \ltnote{%
    Try-first: gives students a chance to propose brute force vs statistics.
    In discussion, collect both and use them to motivate the concept of
    \enquote{keyspace} and \enquote{structure leakage}.
  }
\end{frame}

\begin{frame}
  \begin{block}{Cryptanalysis of Caesar}
    \begin{itemize}
      \item Brute force: try all keys (tiny keyspace).
      \item Statistics: letter frequencies are preserved (just ``rotated'').
      \item If we guess one plaintext letter \(\alpha\) maps to ciphertext
        letter \(\beta\), then \(k = \beta - \alpha \bmod n\).
    \end{itemize}
  \end{block}
\end{frame}

% add figure of polar plot for caesar cipher.

\begin{frame}
  \begin{definition}[Substitution cipher]
    \begin{itemize}
      \item Key: a permutation \(\sigma\) of the alphabet.
      \item Encryption: \(c_i = \sigma(m_i)\).
      \item Decryption: \(m_i = \sigma^{-1}(c_i)\).
    \end{itemize}
  \end{definition}
\end{frame}

\begin{frame}
  \begin{block}{Cryptanalysis: structure still leaks}
    \begin{itemize}
      \item Single-letter frequencies leak (A/E/T/... are uneven).
      \item Digrams/trigrams (``th'', ``the'', ...) give more clues.
      \item A large keyspace is not enough if the scheme leaks structure.
    \end{itemize}
  \end{block}
\end{frame}

% add graph of substitution cipher frequency analysis.

\begin{frame}
  \begin{definition}[Vigen\`ere cipher]
    \begin{itemize}
      \item Key: a short sequence \(k_0,\ldots,k_{\ell-1}\) reused periodically.
      \item Encryption: \(c_i = m_i + k_{i\bmod\ell} \bmod n\).
      \item Decryption: \(m_i = c_i - k_{i\bmod\ell} \bmod n\).
    \end{itemize}
  \end{definition}
\end{frame}

\begin{frame}
  \begin{block}{Cryptanalysis of Vigen\`ere (simple version)}
    \begin{itemize}
      \item If we guess the key length \(\ell\), then we split the ciphertext
        into \(\ell\) columns.
      \item Each column is a Caesar cipher with its own shift.
      \item Try plausible \(\ell\) and test for language-like statistics.
    \end{itemize}
  \end{block}
\end{frame}

% we should add Hill cipher
% diffuses statustics over blocks --- fixes Vigénère.
% but still linear algebra --- vulnerable to known-plaintext attacks.
% cover known-plaintext, chosen-plaintext attacks,
% chosen ciphertext and adaptive chosen-ciphertext attacks later.

\subsection{Security properties and pitfalls}

\begin{frame}
  \begin{definition}[Perfect secrecy]
    \begin{itemize}
      \item Random variables \(M\) (message) and \(C\) (ciphertext).
      \item Perfect secrecy means: \(\Pr(M=m\mid C=c)=\Pr(M=m)\) for all
        \(m,c\).
    \end{itemize}
  \end{definition}

  \pause

  \begin{remark}
    Perfect secrecy is possible (one-time pad), but expensive in key material.
  \end{remark}
\end{frame}

\begin{frame}
  \begin{block}{One-time pad (OTP)}
    \begin{itemize}
      \item Key is as long as the message, uniformly random, used once.
      \item Gives perfect secrecy.
      \item Key distribution and key reuse are the practical obstacles.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{block}{Key length and brute force}
    \begin{itemize}
      \item If the best attack is brute force, security grows with key length.
      \item Doubling key length squares brute-force work.
      \item Symmetric keys (e.g., 128--256 bits) can be enough in practice.
    \end{itemize}
  \end{block}
\end{frame}


\begin{frame}
  \begin{exercise}
    Alice sends Bob an encrypted message.

    An attacker flips a few bits in the ciphertext.

    What do you think Bob will notice when decrypting?
  \end{exercise}

  \ltnote{%
    Try-first: many students implicitly assume encryption implies
    tamper-detection. This question surfaces that misconception before we state
    the separation between confidentiality and integrity.
  }
\end{frame}

\begin{frame}
  \mode<presentation>{%
    \begin{block}{Encryption does not give integrity}
      \begin{itemize}
        \item Encryption hides content, but does not necessarily detect tampering.
        \item Bob can often decrypt a modified ciphertext into \enquote{garbage}
          without knowing it was modified.
        \item Integrity requires additional mechanisms (covered later).
      \end{itemize}
    \end{block}
  }
  \mode<article>{%
    \begin{block}{Encryption does not give integrity}
      The purpose of encryption is confidentiality: an eavesdropper should not
      learn the message.
      But confidentiality alone does not mean the receiver can detect if the
      ciphertext was modified.

      Many encryption schemes are \emph{malleable}: an attacker can change the
      ciphertext in a way that results in a predictable (or at least different)
      plaintext after decryption.
      To get tamper detection we need integrity protection, typically by using a
      MAC or an authenticated-encryption scheme.
    \end{block}
  }
\end{frame}

% expand on the idea of composing small ciphers into larger ones
% AES as an example: permutation-substitution network.
% Shannon calls this confusion and diffusion.

% how to choose the key size.
% We want 128 bit security, what does that mean?
% Why will AES-256 give only 128 bits in a quantum computer world? Grover's 
% algorithm.

\section{Block modes}

\subsection{Why modes?}

\begin{frame}
  \begin{block}{Block ciphers need a mode of operation}
    \begin{itemize}
      \item Real messages are longer than one block.
      \item A \emph{mode} specifies how to encrypt many blocks.
      \item A bad mode can leak patterns even if the block cipher is strong.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{exercise}
    Suppose you encrypt a bitmap image block-by-block.

    What would you expect the ciphertext image to look like if you encrypt each
    block independently with the same key?
  \end{exercise}

  \ltnote{%
    Try-first before ECB: students can reason about repetition/patterns without
    knowing the term \enquote{ECB}. This sets up the contrast that motivates
    modes.
  }
\end{frame}

\begin{frame}
  \begin{block}{ECB (Electronic Codebook) leaks patterns}
    \begin{itemize}
      \item Each block encrypted independently.
      \item Equal plaintext blocks \(\Rightarrow\) equal ciphertext blocks.
      \item Structure in the plaintext becomes visible.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{figure}
    \begin{sidecaption}[Tux encrypted using different modes.]{%
      Tux encrypted using different block modes of operation.
      When using ECB mode, we can still distinguish Tux.
      With CTR, the ciphertext looks random.
    }[fig:EncModes]
    \hfill
    \begin{subfigure}[t]{0.3\linewidth}
      \includegraphics[width=\linewidth]{../../../project/figs/Tux.pdf}
      \caption{Original Tux.
      Image by: Larry Ewing, Simon Budig, Garrett LeSage.}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.3\linewidth}
      \includegraphics[width=\linewidth]{../../../project/figs/Tux_encrypted_ecb.png}
      \caption{ECB-encrypted Tux.
      Image by: RFL890.}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.3\linewidth}
      \includegraphics[width=\linewidth]{../../../project/figs/Tux_encrypted_ctr.png}
      \caption{CTR-encrypted Tux.
      Image by: RFL890.}
    \end{subfigure}
    \hspace{\fill}
    \end{sidecaption}
  \end{figure}

  \ltnote{%
    Core contrast example: keep key/plaintext invariant and vary only the mode
    (ECB vs CTR).
  }
\end{frame}

\subsection{Common modes (properties)}

% explain how they function, what they do to achieve this.

\begin{frame}
  \mode<presentation>{%
    \begin{block}{CBC, CTR, CFB, OFB: what differs?}
      \begin{itemize}
        \item How randomness enters (IV/nonce).
        \item Whether encryption can be parallelised.
        \item Error propagation (a bit flip affects how much?).
        \item Random access: can you decrypt block \(i\) without earlier blocks?
      \end{itemize}
    \end{block}
  }
  \mode<article>{%
    \begin{block}{CBC, CTR, CFB, OFB: what differs?}
      These modes combine a block cipher with an IV/nonce and feedback in
      different ways.
      We focus on high-level properties: which misuse breaks confidentiality,
      and which modes are convenient for implementation (parallelism, random
      access, and error propagation).
    \end{block}
  }

  \ltnote{%
    We avoid construction details and focus on properties that students need for
    safe use.
  }
\end{frame}

\begin{frame}
  \begin{block}{CBC (Cipher Block Chaining) --- properties}
    \begin{itemize}
      \item Uses a random/unpredictable IV.
      \item Hides patterns across blocks.
      \item Encryption is sequential (depends on previous ciphertext).
      \item Bit flips affect the current block and the next block.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{block}{CTR (Counter mode) --- properties}
    \begin{itemize}
      \item Uses a unique nonce (and counter) to create a keystream.
      \item Parallelisable and supports random access.
      \item Bit flips in ciphertext flip the corresponding plaintext bits.
      \item Nonce reuse is catastrophic.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \mode<presentation>{%
    \begin{block}{CFB and OFB --- properties}
      \begin{itemize}
        \item Turn a block cipher into a stream-cipher-like scheme.
        \item CFB is self-synchronising; OFB is not.
        \item Both require IV/nonce discipline to avoid reuse.
      \end{itemize}
    \end{block}
  }
  \mode<article>{%
    \begin{block}{CFB and OFB --- properties}
      CFB (Cipher Feedback) and OFB (Output Feedback) are older modes that
      effectively use a block cipher to generate a keystream.
      They are less common in modern protocols than CTR and AEAD modes, but they
      illustrate the design space: how feedback affects synchronisation and
      error propagation.
    \end{block}
  }
\end{frame}

\subsection{IVs/nonces and misuse}

\begin{frame}
  \begin{block}{IV/nonce: what it is and why it matters}
    \begin{itemize}
      \item A public value used to randomise encryption.
      \item Must be unique (and sometimes unpredictable), depending on the mode.
      \item Reuse can destroy confidentiality.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{exercise}
    In CTR mode, encryption looks like
    \(c = m \oplus \text{keystream}(k,\text{nonce})\).

    What do you think happens if the same nonce is reused for two different
    messages?
  \end{exercise}

  \ltnote{%
    Try-first: students can compute \(c_1\oplus c_2\) themselves and discover
    the key invariant (same keystream) before we state the rule.
  }
\end{frame}

\begin{frame}
  \begin{block}{CTR nonce reuse: the disaster in one line}
    \begin{itemize}
      \item CTR gives: \(c = m \oplus \text{keystream}(k,\text{nonce})\).
      \item If nonce reused: \(c_1\oplus c_2 = m_1\oplus m_2\).
      \item This leaks relations between messages and is often enough to recover
        both.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{exercise}
    What must be true about IV/nonce values for repeated encryptions under the
    same key?
  \end{exercise}

  \ltnote{%
    Post-test: students should now articulate IV/nonce uniqueness without being
    cued by a specific scenario.
  }
\end{frame}

\begin{frame}
  \mode<presentation>{%
    \begin{block}{Later: authenticated encryption and storage modes}
      \begin{itemize}
        \item AEAD: encryption + integrity in one scheme.
        \item GCM: widely used AEAD mode.
        \item XTS: disk/storage encryption mode.
      \end{itemize}
    \end{block}
  }
  \mode<article>{%
    \begin{block}{Later: authenticated encryption and storage modes}
      In practice we rarely use \enquote{bare} confidentiality.
      We often need authenticated encryption, where the receiver can both decrypt
      and detect tampering.
      This is commonly provided by AEAD schemes, such as GCM.

      For disk encryption the requirements are different (random access, no
      per-sector nonces), and specialised modes such as XTS are used.
      We will return to these later.
    \end{block}
  }
\end{frame}

\begin{frame}
  \begin{block}{Take-away}
    \begin{itemize}
      \item Modes matter: ECB is not acceptable for structured data.
      \item Pick a mode with good properties for your setting (parallelism,
        random access, error propagation).
      \item IV/nonce discipline is part of the security definition.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}
  \begin{center}
    Questions?
  \end{center}
\end{frame}


\mode<all>\endinput

DD2520 Applied Cryptography
Lecture 2

Douglas Wikström
KTH Royal Institute of Technology
dog@kth.se

January 18, 2022

What is cryptography?

Cryptographic Concepts

The focus of the first part of this course is cryptographic
concepts, but not mathematical details.
Several cryptographic notions are digitized versions of physical
objects or everyday processes.
We rely heavily on analogies in our presentation to give a working
knowledge of how to apply the primitives and understand their
security properties.
Interested students may take DD2448 Foundations of cryptography
in Period 4 for a more rigorous treatment.

Cipher (Symmetric Cryptosystem)

m = E−1
k (c)

c = Ek (m)

m

E

Alice

k

c

E−1

m

k

Bob

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where
◮ Gen is a probabilistic key generation algorithm outputting
keys from a key space K,

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where
◮ Gen is a probabilistic key generation algorithm outputting
keys from a key space K,
◮ P is a set of plaintexts,

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where
◮ Gen is a probabilistic key generation algorithm outputting
keys from a key space K,
◮ P is a set of plaintexts,
◮ E is a deterministic encryption algorithm, and

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where
◮ Gen is a probabilistic key generation algorithm outputting
keys from a key space K,
◮ P is a set of plaintexts,
◮ E is a deterministic encryption algorithm, and
◮ E−1 is a deterministic decryption algorithm,

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where
◮ Gen is a probabilistic key generation algorithm outputting
keys from a key space K,
◮ P is a set of plaintexts,
◮ E is a deterministic encryption algorithm, and
◮ E−1 is a deterministic decryption algorithm,
such encryption followed by decryption recovers the message.

Cipher (Symmetric Cryptosystem)
Definition. A cipher (symmetric cryptosystem) is a tuple
(Gen, P, E, E−1 ), where
◮ Gen is a probabilistic key generation algorithm outputting
keys from a key space K,
◮ P is a set of plaintexts,
◮ E is a deterministic encryption algorithm, and
◮ E−1 is a deterministic decryption algorithm,
such that E−1
k (Ek (m)) = m for every m ∈ P and every k ∈ K.

Caesar Cipher (Shift Cipher)
Consider English, with alphabet A-Z , where
thought of as integers modulo 27, i.e., Z27 .

denotes space,

◮ Key. Random letter k ∈ Z27 .
◮ Encrypt. Plaintext m = (m1 , . . . , mn ) ∈ Zn27 gives ciphertext
c = (c1 , . . . , cn ), where
ci = mi + k mod 27 .
◮ Decrypt. Ciphertext c = (c1 , . . . , cn ) ∈ Zn27 gives plaintext
m = (m1 , . . . , mn ), where
mi = ci − k mod 27 .

Caesar Cipher (Example)
Encoding the alphabet as Z27.
a b c d e f g h i j k l m n o p q r s t u v w x y z
00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26

Example
Key: G = 6
Substitution table:
a b c d e f g h i j k l m n o p q r s t u v w x y z
G H I J K L M N O P Q R S T U V W X Y Z - A B C D E F

Plaintext: b r i b e
l u l a
t o
b u y
j a s
Plaintext: 01 17 08 01 04 26 11 20 11 00 26 19 14 26 01 20 24 26 09 00 18
Ciphertext: 07 23 14 07 10 05 17 26 17 06 05 25 20 05 07 26 03 05 15 06 24
Ciphertext: H X O H K F R - R G F Z U F H - D F P G Y

Letter Frequencies (1/2)
Letters occur with very different frequencies in natural languages.
The following is a frequency table for English.
A
B
C
D
E
F
G
H
I

0.072
0.013
0.024
0.037
0.112
0.020
0.018
0.054
0.061

J
K
L
M
N
O
P
Q
R

0.001
0.007
0.035
0.021
0.059
0.066
0.017
0.001
0.053

S
T
U
V
W
X
Y
Z

0.056
0.080
0.024
0.009
0.021
0.001
0.017
0.001
0.120

Letter Frequencies (1/2)
Letters occur with very different frequencies in natural languages.
The following is a frequency table for English.
A
B
C
D
E
F
G
H
I

0.072
0.013
0.024
0.037
0.112
0.020
0.018
0.054
0.061

J
K
L
M
N
O
P
Q
R

0.001
0.007
0.035
0.021
0.059
0.066
0.017
0.001
0.053

S
T
U
V
W
X
Y
Z

0.056
0.080
0.024
0.009
0.021
0.001
0.017
0.001
0.120

The same frequencies appear in a ciphertext of written English,
but in shifted order!

Letter Frequencies (2/2)

Cryptanalysis of the Caesar Cipher

◮ Exploit structure. If we know that a single letter α is
encrypted into a ciphertext letter β, then k = β − α mod 27.
◮ Brute force. Try all keys and check if the result is English,
e.g., by counting Google hits. This works since the keyspace is
very small.
◮ Statistics and structure. “Rotate” until the letter
frequences of the ciphertext and English match. Works for
any “language” with non-uniform letter frequencies!

Polar Plot of Letter Frequencies (log-scaled for clarity)

Substitution Table (Key: G=6)

Attacker’s View of a Ciphertext

Rotate Until It Matches Letter Frequencies

Interpret

Substitution Cipher
What if we use a randomly chosen table to substitute one letter for
another instead of rotation?

(This ciphertext was captured in my apartment, but never cryptanalyzed.)

Substitution Cipher

◮ Key. Random permutation σ ∈ S of the symbols in the
alphabet, for some subset S of all permutations.
◮ Encrypt. Plaintext m = (m1 , . . . , mn ) ∈ Zn27 gives ciphertext
c = (c1 , . . . , cn ), where ci = σ(mi ).
◮ Decrypt. Ciphertext c = (c1 , . . . , cn ) ∈ Zn27 gives plaintext
m = (m1 , . . . , mn ), where mi = σ −1 (ci ).

Cryptanalysis of the Substitution Cipher

Sorted
English
Frequencies

Group by similar
frequency and brute
force within each group!

Sorted
Ciphertext
Frequencies

This bar chart is not
identical to the above!

Digrams and Trigrams

To differentiate symbols which have similar frequencies and/or are
rare during deciphering, it is useful to compute frequency tables for
the most frequent digrams and trigrams.
◮ A digram is an ordered pair of symbols.
◮ A trigram is an ordered triple of symbols.
Examples: “sh”, “the”, “I ”,...

Generic Attack Against Substitution Cipher

1. Compute symbol/digram/trigram frequency tables for the
candidate language and the ciphertext.
2. Try to match symbols/digrams/trigrams with similar
frequencies.
3. Try to recognize words to confirm your guesses (we would use
a dictionary or Google).
4. Backtrack/repeat until the plaintext can be guessed.

Vigénère

A single letter encrypted with the Caesar cipher gives a random
ciphertext letter.
How do we achieve something similar for more than one letter?

Vigénère

A single letter encrypted with the Caesar cipher gives a random
ciphertext letter.
How do we achieve something similar for more than one letter?
Vigénère Cipher.
◮ Key. k = (k0 , . . . , kl−1 ), where ki ∈ Z27 is random.
◮ Encrypt. Plaintext m = (m1 , . . . , mn ) ∈ Zn27 gives ciphertext
c = (c1 , . . . , cn ), where ci = mi + ki mod l mod 27.
◮ Decrypt. Ciphertext c = (c1 , . . . , cn ) ∈ Zn27 gives plaintext
m = (m1 , . . . , mn ), where mi = ci − ki mod l mod 27.

Attack Vigénère (1/2)

◮ Each probability distribution p1 , . . . , pn on n symbols may be
viewed as a point p = (p1 , . . . , pn ) on a n − 1 dimensional
hyperplane in Rn orthogonal to the vector 1
p
◮ Such a point p = (p1 , . . . , pn ) is at distance F (p) from the
P
origin, where F (p) = ni=1 pi2 .
◮ It is clear that p is closest to the origin, when p is the uniform
distribution, i.e., when F (p) is minimized. (Draw picture!)
◮ F (p) is invariant under permutation of the underlying symbols
−→ tool to check if a set of symbols is (likely) the result of
some substitution cipher (for non-uniform plaintext sources).

Attack Vigénère (2/2)
1. For l = 1, 2, 3, . . ., we form

 
C0
c0
 C1   c1

 
 ..  =  ..
 .   .

c2l

cl+1
..
.

c2l+1
..
.


···
··· 

.. 
. 

cl−1 c2l−1 c3l−1 · · ·

Cl−1

and compute fl = 1l

cl

Pl−1

i =0 F (Ci ).

Smallest local maximum is probably the key length.
2. Attack each Ci separately to recover ki , using the attack
against the Caesar cipher.

Attack Vigénère (2/2)
1. For l = 1, 2, 3, . . ., we form

 
C0
c0
 C1   c1

 
 ..  =  ..
 .   .

c2l

cl+1
..
.

c2l+1
..
.


···
··· 

.. 
. 

cl−1 c2l−1 c3l−1 · · ·

Cl−1

and compute fl = 1l

cl

Pl−1

i =0 F (Ci ).

Smallest local maximum is probably the key length.
2. Attack each Ci separately to recover ki , using the attack
against the Caesar cipher.
English can no longer be recognized, but statistics don’t lie!

What went wrong?

Vigénère does smooth out the statistics, but only the global
statistics.
We need to diffuse the statistics in such a way that it is infeasible
to exploit marginal distributions.

Hill Cipher
◮ Key. k = A, where A is an invertible l × l -matrix over Z27 .
◮ Encrypt. Plaintext m = (m1 , . . . , mn ) ∈ Zn27 gives ciphertext
c = (c1 , . . . , cn ), where (computed modulo 27):
(ci +0 , . . . , ci +l−1 ) = (mi +0 , . . . , mi +l−1 )A .
◮ Decrypt. Ciphertext c = (c1 , . . . , cn ) ∈ Zn27 gives plaintext
m = (m1 , . . . , mn ), where (computed modulo 27):
(mi +0 , . . . , mi +l−1 ) = (ci +0 , . . . , ci +l−1 )A−1 .
for i = 1, l + 1, 2l + 1, . . .
Transposition cipher is a special case. Vigénère is similar to using a
diagonal Hill matrix.

Cryptanalysis of Linear Ciphers

Given plaintexts-ciphertext pairs of the form

(mi ,1 , . . . , mi ,n ), (ci ,n , . . . , ci ,n )
for i = 1, . . . , n we likely get a solvable equation system in the
unknowns ai ,j :
C =M ×A
where C = (ci ,j )i ,j∈[n] , M = (mi ,j )i ,j∈[n] , and A = (ai ,j )i ,j∈[n] .
Linear ciphers can be broken with a known plaintext attack!

Weak Ciphers Summarized
◮ Invertible substitution:
mi 7→ σ(mi )

◮ Invertible linear map:
(m1 , . . . , ml ) 7→ (m1 , . . . , ml )A

Weak Ciphers Summarized
◮ Invertible substitution:
mi 7→ σ(mi )
Confusing map without structure, but too small key space
and susceptible to statistical analysis.
◮ Invertible linear map:
(m1 , . . . , ml ) 7→ (m1 , . . . , ml )A

Weak Ciphers Summarized
◮ Invertible substitution:
mi 7→ σ(mi )
Confusing map without structure, but too small key space
and susceptible to statistical analysis.
◮ Invertible linear map:
(m1 , . . . , ml ) 7→ (m1 , . . . , ml )A
Diffusing map which turns most marginal statistics into
smooth global statistics and large keyspace, but the key can
be recovered by solving a linear equation system.

Weak Ciphers Summarized
◮ Invertible substitution:
mi 7→ σ(mi )
Confusing map without structure, but too small key space
and susceptible to statistical analysis.
◮ Invertible linear map:
(m1 , . . . , ml ) 7→ (m1 , . . . , ml )A
Diffusing map which turns most marginal statistics into
smooth global statistics and large keyspace, but the key can
be recovered by solving a linear equation system.
Anything that is approximately the same is also weak!

Simple Ciphers are Bad, What is a Good Block Cipher?

◮ For every key a block-cipher with plaintext/ciphertext space
{0, 1}n gives a permutation of {0, 1}n .
◮ A perfect block cipher is one where each key gives a
randomly chosen permutation of {0, 1}n .
Bad news! The representation of a single key requires
roughly n2n bits, e.g., 147 × 106·3 bits for n = 64.
◮ Can we construct a cipher that may not be perfect, but good
enough for practice?
Something that is indistinguishable from perfect to any
computationally bounded adversary?

Modern Ciphers

Idea. Compose smaller weak ciphers into a large one.

Modern Ciphers

Idea. Compose smaller weak ciphers into a large one.
Shannon (1948) calls this:
◮ Confusion. “The method of confusion is to make the relation
between the simple statistics of E and the simple description
of K a very complex and involved one.”
◮ Diffusion. “In the method of diffusion the statistical
structure of M which leads to its redundancy is dissipated into
long range statistics...”

Substitution-Permutation Networks (1/2)

◮ Block-size. We use a block-size of n = ℓ × m bits.
◮ Key Schedule. Round r uses its own round key Kr derived
from the key K using a key schedule.
◮ Each Round. In each round we invoke:
1. Round Key. xor with the round key.
2. Substitution. ℓ substitution boxes each acting on one m-bit
word (m-bit S-Boxes).
3. Permutation. A permutation πi acting on {1, . . . , n} to
reorder the n bits.

Substitution-Permutation Networks (2/2)
Ui −1
Ki

Substitution-Permutation Networks (2/2)
Ui −1
L

Ki
Xi

xor with
round key

Substitution-Permutation Networks (2/2)
Ui −1
L

Ki

xor with
round key

Xi
Si ,1
Yi

Si ,2

Si ,3

Si ,4

substitute
words

Substitution-Permutation Networks (2/2)
Ui −1
L

Ki

xor with
round key

Xi
Si ,1

Si ,2

Si ,3

Si ,4

substitute
words

Yi
πi

Ui

permute
bits

Substitution-Permutation Networks (2/2)
Ui −1
L

Ki

xor with
round key

Xi
Si ,1

Si ,2

Si ,3

Si ,4

substitute
words

Yi
permute
bits

Ui

Substitution-Permutation Networks (2/2)
Ui −1
Ki

Round i

Ui

A Simple Block Cipher (1/2)

◮ |P| = |C | = 16
◮ 4 rounds
◮ |K | = 32
◮ r th round key Kr consists of
the 4r th to the (4r + 16)th
bits of key K .
◮ 4-bit S-Boxes

A Simple Block Cipher (2/2)

S-Boxes the same (S 6= S −1 )

◮ Y = S(X )
◮ Can be described using 4 boolean functions

Input
Output

0
E

1
4

2
D

3
1

4
2

5
F

6
B

7
8

8
3

9
A

A
6

B
C

C
5

D
9

E
0

F
7

A Simple Block Cipher (2/2)

S-Boxes the same (S 6= S −1 )

◮ Y = S(X )
◮ Can be described using 4 boolean functions

Input
Output

0
E

1
4

2
D

3
1

4
2

5
F

6
B

7
8

8
3

9
A

A
6

B
C

C
5

D
9

E
0

F
7

13
4

14
8

15
12

16-bit permutation (π = π −1 )
Input
Output

1
1

2
5

3
9

4
13

5
2

6
6

7
10

8
14

9
3

10
7

11
11

12
15

16
16

Advanced Encryption Standard (AES)

◮ Chosen in worldwide public competition 1997-2000.
Probably no backdoors. Increased confidence!
◮ Winning proposal named “Rijndael”, by Rijmen and Daemen
◮ Family of 128-bit block ciphers:

Key bits
Rounds

128
10

192
12

256
14

◮ The first key-recovery attacks on full AES due to Bogdanov,
Khovratovich, and Rechberger, published 2011, is faster than
brute force by a factor of about 4.


